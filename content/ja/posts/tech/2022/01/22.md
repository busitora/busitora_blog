---
author: "Hugo Authors"
title: "committeeã‚’ä½¿ã£ãŸSchemaé§†å‹•é–‹ç™º"
date: 2022-01-22
description: "Schemaé§†å‹•é–‹ç™º"
draft: false
hideToc: false
enableToc: true
enableTocContent: false
author: ãƒ–ã‚·ãƒˆãƒ©
authorEmoji: ğŸ¯
tags:
- rails
- committee
image: test/committee.png
---

å®Ÿå‹™ã§ã€committeeã‚’å°å…¥ã—ãŸã®ã§ã€ãã®æ™‚ã®ãƒ¡ãƒ¢ã‚’æ›¸ãã€‚

## çµŒç·¯ã¨å•é¡Œç‚¹

å¼Šç¤¾ã®ã‚µãƒ¼ãƒ“ã‚¹Aã¯ã€ãƒ¢ãƒãƒªã‚¹ãªRailsã®ã‚¢ãƒ—ãƒªã‚±ãƒ¼ã‚·ãƒ§ãƒ³ã§ã‚ã‚‹ãŒã€ãã®ä»–ç¤¾å†…ã‚µãƒ¼ãƒ“ã‚¹è¤‡æ•°ã‹ã‚‰APIã‚µãƒ¼ãƒã¨ã—ã¦ä½¿ã‚ã‚Œã¦ã„ã‚‹ãŒã€Swaggerã«é–¢ã—ã¦è‰²ã€…å•é¡ŒãŒã‚ã£ãŸã€‚

{{< box >}}
Swaggerã®æ˜ç¢ºãªæ›¸ãæ–¹ãŒãªãã€ã‚¨ãƒ³ã‚¸ãƒ‹ã‚¢ãŒæ—¢å­˜ã‚³ãƒ¼ãƒ‰ã‚’æ¨¡å€£ã—ã¦æ›¸ã„ã¦ã„ã‚‹
ä¸€ã¤ã®ymlãƒ•ã‚¡ã‚¤ãƒ«ãŒã‚¢ãƒ›ã»ã©å¤§ãããªã‚Šã€å¯èª­æ€§ãŒæ‚ªã„ã€‚
å®Ÿéš›ã®Swaggerã¨å®Ÿè£…ãŒå¾®å¦™ã«ä¹–é›¢ã—ã¦ã„ã‚‹éƒ¨åˆ†ãŒã‚ã‚‹
{{< /box >}}

ãªã©ã€æ–°ã—ã„APIã‚’ç”Ÿã‚„ã™ã®ã¯ã„ã„ãŒã€ãã‚Œã‚’ç®¡ç†ã§ããšã«ã€APIã«ã¤ã„ã¦ã®ç¢ºèªä¾é ¼ãŒé£›ã‚“ã§ãã¦ã€Aã‚µãƒ¼ãƒ“ã‚¹ã®ã‚¨ãƒ³ã‚¸ãƒ‹ã‚¢ã¨åˆ¥éƒ¨ç½²ã®äººé–“ãŒã‚³ãƒŸãƒ¥ãƒ‹ã‚±ãƒ¼ã‚·ãƒ§ãƒ³ã‚’å–ã‚‰ã–ã‚‹ã‚’å¾—ãªã‹ã£ãŸã€‚

ãã“ã§ã€åå‰ã ã‘çŸ¥ã£ã¦ã„ãŸã‚¹ã‚­ãƒ¼ãƒé§†å‹•é–‹ç™ºã‚’ã‚°ã‚°ã£ã¦ã¿ãŸæ‰€ã€committeeã¨ã„ã†gemã‚’ä½¿ã†ã¨è‰¯ã•ãã†ã€‚ã¨ã„ã£ãŸæµã‚Œã§ã‚ã‚‹ã€‚

## committeeã®èª¬æ˜

æ²¢å±±è¨˜äº‹ãŒã‚ã‚‹ã®ã§è©³ç´°ã¯å‰²æ„›ã™ã‚‹ãŒã€committeeã¯ä¸‹è¨˜ã€‚

> committeeã¯ã€å®Ÿéš›ã®APIãƒªã‚¯ã‚¨ã‚¹ãƒˆã‚„ãƒ¬ã‚¹ãƒãƒ³ã‚¹ãŒã‚¹ã‚­ãƒ¼ãƒå®šç¾©ã«ãã£ã¦ã„ã‚‹ã‹ã‚’ãƒã‚§ãƒƒã‚¯ã™ã‚‹ã“ã¨ãŒã§ãã‚‹gemã§ã€
å®Ÿéš›ã®APIãƒªã‚¯ã‚¨ã‚¹ãƒˆã‚„ãƒ¬ã‚¹ãƒãƒ³ã‚¹ãŒã‚¹ã‚­ãƒ¼ãƒå®šç¾©ã«ãã£ã¦ã„ã‚‹ã‹ã‚’ãƒã‚§ãƒƒã‚¯ã™ã‚‹ã“ã¨ãŒã§ãã€Rackã®ãƒŸãƒ‰ãƒ«ã‚¦ã‚§ã‚¢ã¨ã—ã¦å‹•ä½œã—ã¾ã™

[å…¬å¼gem](https://github.com/interagent/committee) ã‚’è‰²ã€…è¦‹ã‚‹ã¨ã ã„ãŸã„åˆ†ã‹ã‚‹

### committee Rails
ãŸã ã€committeeã‚’Railsã§ä½¿ãˆã‚‹ã‚ˆã†ã«ã™ã‚‹ã®ã«ã¯ã€[committee-rails](https://github.com/willnet/committee-rails)ãŒå¿…è¦ã€‚

ã‚ˆãä½¿ã†ãƒ¡ã‚½ãƒƒãƒ‰ã¯ã“ã‚Œã€‚ä¸€å¿œå‚è€ƒã¾ã§

å®Ÿéš›ã‚ˆãã¤ã‹ã†ã®ã¯ã“ã‚Œ â†’  [assert_response_schema_confirm](https://github.com/interagent/committee/blob/master/lib/committee/test/methods.rb#L20)

## ä½¿ã„æ–¹

```Gemfire.rb
  gem "committee"
  gem "committee-rails"
```

ã‚’ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«ã€‚
`rails_helper.rb` ã«ã€ä¸‹è¨˜ã‚’è¿½åŠ ã€‚(pjã«ã‚ˆã£ã¦ Rails.root.join ã®å¾Œã¯å¤‰ãˆã‚‹å¿…è¦ãŒã‚ã‚‹)

```rails_helper.rb
config.include Committee::Rails::Test::Methods #æ¯å›å„Specã§ includeã™ã‚‹ã®ã¯é¢å€’ãªã®ã§
config.add_setting :committee_options
config.committee_options = { schema_path: Rails.root.join('schema', 'schema.json').to_s,
parse_response_by_content_type: false # ãªãã¦ã‚‚ã„ã„ã‘ã©WarningãŒå‡ºã¾ã™
# prefix: "/api/v1" â† ã¨ã™ã‚‹ã¨ã€yamlã§api/v1ã¨ã‹ã‹ãªãã¦ã„ã„ã®ã§æ¥½ã ãŒã€ã“ã“ã¯ãŠå¥½ã¿ã§
```
2ã¤ã®gemã‚’ã„ã‚Œã‚‹ã“ã¨ã«ã‚ˆã‚Šã€`assert_response_schema_confirm` ãŒä½¿ãˆã‚‹ã‚ˆã†ã«ãªã‚‹ã€‚
`assert_response_schema_confirm` ã¯ã€æ›¸ã‹ã‚ŒãŸãƒ‰ã‚­ãƒ¥ãƒ¡ãƒ³ãƒˆã¨ãƒ¬ã‚¹ãƒãƒ³ã‚¹ãŒä¸€è‡´ã—ã¦ã‚‹ã‹ãƒ†ã‚¹ãƒˆã—ã¦ãã‚Œã‚‹ä»£ç‰©ã€‚å¾Œè¿°ã™ã‚‹ã€‚
### ä¾‹  getã™ã‚‹ã¨userã®idã¨nameã‚’è¿”ã™

#### routing
```config/route/api.rb
module Api
  def self.extended(router) # rubocop:disable Metrics/MethodLength
    router.instance_exec do
      namespace :api do
        namespace :v1 do
           get "swagger_sandbox", to: "tests#sandbox" unless Rails.env.
           <!-- èª¬æ˜ã®ãŸã‚é©å½“ -->
           production?
        end
      end
    end
  end
end
```

#### controller
getã—ãŸã‚‰é©å½“ã«userã®idã¨nameã‚’è¿”ã™ã‚ˆã†ã«ã™ã‚‹

```api/v1/tests_controller.rb
class Api::V1::TestsController < Api::BaseController
  def sandbox
    render json: { user: { id: 1, name: "busitora" } }, status: :ok
  end
end
```

#### Spec
```swagger_sandbox_request_spec.rb
require "rails_helper"

RSpec.describe Api::V1::TestsController, type: :request do

  describe "GET #sandbox" do
    subject {
      get(api_v1_swagger_sandbox_path,
      headers: { Authorization: "Token token=#{ENV["API_TOKEN"]}" })
    }

    before do
      subject
    end

    context "when success" do
      let(:return_http_status) { 200 }

      it "return expected status" do
        expect(response).to have_http_status(return_http_status)
      end

      it "return expected body schema" do
        assert_response_schema_confirm
      end
    end
  end
end
```

`assert_response_schema_confirm` ãŒå‘¼ã°ã‚ŒãŸæ™‚ã«ã€`rails_helper.rb` ã§è¨­å®šã—ãŸ
`schema_path: Rails.root.join("swagger", "openapi_sandbox.yaml").to_s` ã®ãƒ•ã‚¡ã‚¤ãƒ«ã‚’èª­ã¿ã«è¡Œãã€‚
ä»Šå›ã¯ã€  `openapi_sandbox.yaml` ã¨è¨­å®šã—ãŸã€‚

#### yaml
```openapi_sandbox.yaml
openapi: 3.0.5
info:
  title: OpenAPIãƒ†ã‚¹ãƒˆ
  version: 1.0.0
  description: OpenAPIãƒ†ã‚¹ãƒˆ
servers:
  - url: http://localhost:3000
    description: Local server
  - url: https://staging.test.tokyo
    description: Staging server
paths:
  /api/v1/swagger_sandbox:
    get:
      summary: Get User
      description: ãƒ¦ãƒ¼ã‚¶ãƒ¼1ä»¶ã‚’å–å¾—
      responses:
        "200":
          description: ãƒ¦ãƒ¼ã‚¶ãƒ¼1ä»¶ã‚’å–å¾—
          content:
            application/json:
              schema:
                type: object
                properties:
                  user:
                    $ref: "#/components/schemas/UserModel"
components:
  schemas:
    UserModel:
      type: object
      required:
        - id
        - name
      properties:
        id:
          type: integer
          example: 1
          description: primary id
        name:
          type: string
          example: busitora
          description: åå‰
        additionalProperties: false #ã“ã‚Œã‚’è¿½åŠ ã™ã‚‹ã¨ã€propertiesã§è¨±å®¹ã—ã¦ãªã„ã®ã‚‚å¼¾ã
```

ãªã©ã¨æ›¸ãã€‚ã‚¤ãƒ¡ãƒ¼ã‚¸ã¤ã„ãŸã ã‚ã†ã‹ã€‚

### æˆåŠŸ

#### APIã®è¿”ã‚Šå€¤ã¨yamlã®æœŸå¾…å€¤ãŒã‚ã£ã¦ã„ã‚‹
ä¸Šè¨˜yamlã®æ›¸ãæ–¹ã§ã€`json: { user: { id: 1, name: â€œbusitoraâ€ } }` ã®æœŸå¾…å€¤ã¯ã€
`id` ã¨`name`ãŒå¿…é ˆã§ã‚ã‚‹ã¨ã„ã†è¨­å®šã«ãªã‚‹ã€‚
ã“ã®æ®µéšã§ãƒ†ã‚¹ãƒˆã™ã‚‹ã¨æˆåŠŸã™ã‚‹

### å¤±æ•—
#### yamlã«requiredã‚’è¿½åŠ ã™ã‚‹ãŒè¿”ã‚Šå€¤ã«è¿½åŠ ã—ãªã„
```api/v1/tests_controller.rb
  render json: { user: { id: 1, name: "busitora" } }, status: :ok
```

```yaml
  required:
    - id
    - name
    - age #è¿½åŠ ã™ã‚‹
```

çµæœã¯ä¸‹è¨˜
`Committee::InvalidResponse: #/components/schemas/UserModel missing required parameters: age`

ã€Œyamlã«ã¯ageãŒrequireã«ãªã£ã¦ã‚‹ã®ã«ã€è¿½åŠ ã•ã‚Œã¦ãªã„ã‚ˆã€ã¨è¨€ã£ã¦ãã‚Œã‚‹ã€‚

#### è¿”ã‚Šå€¤ã®å‹ãŒé•ã†æ™‚
```api/v1/tests_controller.rb
  render json: { user: { id: 1, name: "busitora", age : "27" } } status: :ok
```
integerãªã®ã«stringã«ã—ãŸ


```yaml
  required:
    - id
    - name
    - age
  properties:
    id:
      type: integer
      example: 1
      description: primary id
    name:
      type: string
      example: busitora
      description: åå‰
    age:
      type: integer
      example: 27
      description: å¹´é½¢
    additionalProperties: false
```
çµæœã¯ä¸‹è¨˜
`Committee::InvalidResponse:
#/components/schemas/UserModel/properties/age expected string, but received Integer: 27`

å‹ã¯intergerã ã‘ã©ã€stringã§ã‹ãˆã£ã¦ãã¦ã‚‹ã‚„ã‚“ã‘ã‚¨ãƒ©ãƒ¼

#### ä¸è¦ãªå€¤ãŒå…¥ã£ã¦ã„ã‚‹æ™‚(additionalProperties: false ã‚’å¤–ã—ãŸæ™‚)

```test_controller.rb
  render json: { user: { id: 1, name: "busitora" , age: 27, address: "yokohama" } }, status: :ok
```

```yaml
components:
  schemas:
    UserModel:
      type: object
      required:
        - id
        - name
        - age
      properties:
        id:
          type: integer
          example: 1
          description: primary id
        name:
          type: string
          example: busitora
          description: åå‰
        age:
          type: integer
          example: 27
          description: å¹´é½¢
        # additionalProperties: false ã“ã‚Œã¯ã€ä¸è¦ãªãƒ—ãƒ­ãƒ‘ãƒ†ã‚£ã‚’è¨±å®¹ã™ã‚‹ã‹ã©ã†ã‹
```
çµæœã¯ä¸‹è¨˜
`Committee::InvalidResponse:#/components/schemas/CreatorModel does not define properties: address`

ã“ã®ã‚ªãƒ—ã‚·ãƒ§ãƒ³ã¯PJã§ã‚ã‚ã›ã¦ãŠã‹ãªã„ã¨å¤§å¤‰ãªã“ã¨ã«ãªã‚‹ã€‚

### ãƒã‚¤ãƒ³ãƒˆã‚„æ³¨æ„ç‚¹

ControllerSpecã ã¨ã€ãã‚‚ãã‚‚å‹•ã‹ãªã‹ã£ãŸã®ã§RequestSpecã§æ›¸ãå¿…è¦ãŒã‚ã‚‹ã€‚
~~å¼Šç¤¾ã¯ContorollerSpecãŒå¤šã™ãã¦ã€ãã“ã‚’ç½®ãæ›ãˆã‚‹ãŒã¾ãšæ­»ã¬ã»ã©ã‹ã‹ã£ãŸã€‚ã¾ã æ®‹ã£ã¦ã‚‹ã®ã‚‚ã‚ã‚‹~~


ã‚ªãƒ–ã‚¸ã‚§ã‚¯ãƒˆã§ãƒ¢ãƒ‡ãƒ«ã‚’è¿”ã™æ™‚ã¯ã€ãƒ†ã‚¹ãƒˆå¯¾è±¡ã§å¿…é ˆãªã‚«ãƒ©ãƒ ã®ã¿requiredã«ã™ã‚‹ã¹ã â†’ DBã®null ãŒè¨±å®¹ã•ã‚Œã¦ã„ã‚‹ã‚«ãƒ©ãƒ ã«é–¢ã—ã¦ã€ nullable: true ã‚’æ­»ã¬ã»ã©æ›¸ãã“ã¨ã«ãªã‚‹ã€‚
[ãã®ãƒ•ã‚£ãƒ¼ãƒ«ãƒ‰ã€nullable ã«ã—ã¾ã™ã‹ã€requiredã«ã—ã¾ã™ã‹](https://qiita.com/sakuraya/items/2d98c352c74ad72e2a9a)

responseãŒ ã€ `json: "" ` ã ã¨ãƒ†ã‚¹ãƒˆå‡ºæ¥ãªã„ã®ã§ã€destoryä»¥å¤–ã¯ã—ã£ã‹ã‚Šãƒ¬ã‚¹ãƒãƒ³ã‚¹ã§æ“ä½œã—ãŸå¯¾è±¡ã‚’è¿”ã™ã¹ã

### ã‚ˆãä½¿ã†ç”¨èªã‚„ã‚ªãƒ—ã‚·ãƒ§ãƒ³

ãƒ»`assert_response_schema_confirm` â†’ ã‚¨ãƒ³ãƒ‰ãƒã‚¤ãƒ³ãƒˆã®jsonã®ãƒ¬ã‚¹ãƒãƒ³ã‚¹ã¨schemaã®æ•´åˆæ€§ã‚’ãƒã‚§ãƒƒã‚¯
ãƒ»` prefix: â€œ/apiâ€,` â†’ ä»»æ„æŒ‡å®šã§ãã‚‹
ãƒ»`nullable: true` â†’ ãƒ¬ã‚¹ãƒãƒ³ã‚¹ã«ã¯ã‚ã‚‹ãŒã€nilã®ã‚‚ã®

## å°å…¥ã—ã¦ã¿ã¦

{{< box >}}
yamlãŒæ­£ç¾©ã«ãªã‚‹ã®ã§Swaggeré–¢é€£ã®ã‚„ã‚Šå–ã‚ŠãŒæ¸›ã‚‹
APIç”Ÿã‚„ã™ã¨ãã«ãƒ¬ã‚¹ãƒãƒ³ã‚¹ã©ã†ã™ã‚‹ã‹å•é¡Œã‚’çµ±ä¸€ã§ãã‚‹
specã‚’å¼·åˆ¶çš„ã«æ›¸ãç¿’æ…£ãŒç”Ÿã¾ã‚Œã‚‹(å¼Šç¤¾ã¯ã¾ã ã¾ã å¼·åˆ¶ã¯ã§ãã¦ãªã„)
{{< /box >}}

å…¨éƒ¨ã¯æ›¸ã‘ã¦ã„ãªã„ãŒã€å°å…¥ã™ã‚‹ä¾¡å€¤ã¯ã‚ã£ãŸã¨æ€ã†ã€‚
## ä»Šå¾Œç›´ã—ãŸã„ã“ã¨

jsonã§è¿”ã—ã¦ã„ã‚‹å€¤ãŒã€jbuilderã ã£ãŸã‚Šã€ãƒ¬ã‚¹ãƒãƒ³ã‚¹ã‚’200ã‹204ã§è¿”ã™ã‹ãªã©ã€ã¾ã ãƒ«ãƒ¼ãƒ«ãŒæ˜ç¢ºã«æ±ºã¾ã£ã¦ã„ãªã„ã¨ã“ã‚ãŒã‚ã‚‹ã€‚

ãƒ‰ã‚­ãƒ¥ãƒ¡ãƒ³ãƒˆã®ãªã„ã€ã„ã‚ã‚†ã‚‹åŒ–çŸ³ã‚³ãƒ¼ãƒ‰ã®APIã‚’ä¿®æ­£å‡ºæ¥ãšã«ã€`assert_schema_conform` ã®å‹ã«åˆã‚ã›ã‚‰ã‚Œãšä¿®æ­£ã§ãã¦ã„ãªã„éƒ¨åˆ†ãŒã‚ã‚‹

## ã¾ã¨ã‚

ã“ã‚Œã‹ã‚‰APIã‚’é–‹ç™ºã™ã‚‹æ™‚ã¯ã€
1. Schemaã«å¿…è¦ãªæƒ…å ±ã‚’ç¶²ç¾…ã™ã‚‹
2. é–‹ç™º
3. RequestSpec

ã¨ã—ãŸã„ã€‚ãã†ã™ã‚‹ã“ã¨ã§ã€ãƒ‰ã‚­ãƒ¥ãƒ¡ãƒ³ãƒˆã¨ã‚³ãƒ¼ãƒ‰ã®æ•´åˆæ€§ãŒä¿ãŸã‚Œã‚‹ã¨æ€ã†.


## å‚è€ƒ

### swaggerã¨openapiã®é•ã„
ã‚‚ã¨ã‚‚ã¨ Swagger ã¨ã„ã†åå‰ã ã£ãŸã‚‚ã®ãŒã€ OpenAPIã¨åå‰ã‚’å¤‰ãˆã¦ãƒãƒ¼ã‚¸ãƒ§ãƒ³3.0ãŒãƒªãƒªãƒ¼ã‚¹ã•ã‚Œã¾ã—ãŸã€‚
Swaggerã¨èã‘ã°é¦´æŸ“ã¿ã®ã‚ã‚‹æ–¹ã‚‚å¤šã„ã¨æ€ã„ã¾ã™ã€‚
åŸºæœ¬çš„ã«Swaggerã¨OpenAPIã‚’èª­ã¿æ›¿ãˆã¦ã‚‚å•é¡Œã¯ãªã„ã®ã§ã™ãŒã€ï¼ˆãƒ‰ãƒ¡ã‚¤ãƒ³ã¨ã‹æ®‹ã£ã¦ã‚‹ã— => https://swagger.io/specification/ï¼‰
Swaggerã¯2.xã¾ã§ã§ã€OpenAPIã¯3.0ã‹ã‚‰ã«ãªã‚‹ã®ã§ã€Swaggerã®ãƒãƒ¼ã‚¸ãƒ§ãƒ³3ã¨ã„ã†ã‚‚ã®ã¯å³å¯†ã«ã¯å­˜åœ¨ã—ã¾ã›ã‚“ã€‚

ã¨ã®ã“ã¨

### è³‡æ–™ã‚„å‹•ç”»

[[JA] How to use OpenAPI3 for API developer / @ota42y](https://www.youtube.com/watch?reload=9&v=om1dgTbmXrw&feature=emb_logo&ab_channel=RubyKaigi)

[Rails + RSpec + OpenAPI3 + Committeeã§ã‚¹ã‚­ãƒ¼ãƒé§†å‹•é–‹ç™ºã‚’é‹ç”¨ã™ã‚‹Tips](https://tech.timee.co.jp/entry/2020/07/05/150312)

### ä¸€è¨€

ãƒ†ã‚¹ãƒˆæ›¸ã„ã¦ã»ã—ã„ã€‚ã€‚ã€‚

GraphQLã£ã¦ãªã«ãã‚ŒãŠã„ã—ã„ã®ãªã®ã§èª¿ã¹ã¦ã¿ãŸã„
